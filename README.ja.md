# マクロファージ画像4要素解析
**README（日本語版）**

---

## 0. 概要

本リポジトリは **Fiji / ImageJ マクロ**を用いて、**マクロファージ画像中の beads**を半自動で定量するツールを提供します（スクリプト版：**v2.2**）。

主なワークフロー：
- 手動 **細胞 ROI アノテーション**（厳密な検証付き）
- **ターゲット beads 抽出**による尺度推定
- 任意の **排除サンプリング**（複数 beads / ノイズ）
- **二系統 beads 検出**（閾値 + エッジ）と厳密度制御
- **塊の面積推定**と細胞内集計
- 任意の **微量貪食補正**（動的しきい値）
- **データフォーマット / 最適化**（PN/F 解析、IBR/PCR、eIBR/ePCR）

---

## 1. v2.2 更新点

- **データフォーマット機能**：ファイル名規則と列仕様に対応。
- **データ最適化（IBR/PCR）**：プロジェクト間/内のばらつきを調整。
- **排除の厳密化**：画像平均/標準偏差による閾値の動的補正。
- サンプリング推定の強化（ロバスト面積推定 + Rolling Ball 推定）。

---

## 2. 必要環境

- Fiji（推奨）または ImageJ
- 画像形式：`.tif / .tiff / .png / .jpg / .jpeg`

---

## 3. 実行方法（推奨）

非推奨：

```
Fiji → Plugins → Macros → Run...
```

推奨：

1. Fiji を起動
2. **`.ijm` マクロを Fiji ウィンドウへドラッグ＆ドロップ**
3. **Macro Editor** が開く
4. **Run** をクリック

---

## 4. ワークフロー（詳細）

### フェーズ1）言語選択
中文 / English / 日本語を選択。

### フェーズ2）モード選択
- **ROI のみ**：細胞 ROI を作成
- **解析のみ**：既存 ROI を使用して解析
- **ROI + 解析（推奨）**：完全フロー

### フェーズ3）フォルダ選択
画像と ROI があるフォルダを指定。

### フェーズ4）細胞 ROI アノテーション
- 各細胞を描いて **T** で ROI Manager に追加。
- デフォルトで `画像名 + _cells.zip` に保存（変更可）。
- 既存 ROI があれば編集/上書き/スキップを選択。

### フェーズ5）ターゲット beads 抽出
目的：**単一 beads** の尺度を推定。
- 単体 beads を楕円 ROI で選択（塊を避ける）。
- 8-bit コピーで **面積と平均灰度**を測定。
- ランダム順の画像でサンプルを集める。

### フェーズ6）排除サンプリング（任意）
複数 beads / ノイズがある場合に使用。
- 楕円/矩形 ROI：排除対象の **灰度 + 面積**
- Freehand/Polygon ROI：排除領域の **灰度のみ**

### フェーズ7）パラメータ推定
- 面積範囲のロバスト推定
- Rolling Ball 半径推定
- 排除閾値と方向の推定

### フェーズ8）パラメータ確認
- beads 面積範囲、円形度、塊推定、微量貪食補正
- 厳密度（Strict / Normal / Loose）
- 背景 Rolling Ball
- ROI 接尾辞
- 排除（有効化、方向、閾値、厳密、面積ゲート）
- **データフォーマット** と **データ最適化** の設定

### フェーズ9）バッチ解析
各画像で以下を実行：
- 2D / pixel 単位固定
- **細胞ラベルマスク**（16-bit）生成
- 8-bit beads 画像を作成し背景補正
- 二系統検出と融合
- 排除フィルタ
- beads 統計の集計

### フェーズ10）結果出力
- データフォーマット無効：標準 Results 表
- データフォーマット有効：PN/F と列仕様に従う表

---

## 5. コアアルゴリズム（詳細）

### 5.1 ROI → 16-bit ラベルマスク
- ROI ごとに 1..65535 の ID を塗り分け。
- beads の所属細胞をピクセル値で高速判定。
- ROI 数 > 65535 や ROI[1] 不正時は停止。

### 5.2 ターゲット抽出 → 面積推定
- ソート、分位数、IQR に基づくロバスト推定。
- `[minA, maxA]` と代表面積（unit area）を決定。
- サンプル不足はデフォルトにフォールバック。

### 5.3 Rolling Ball 推定
- 代表面積から等価直径を求め、経験式で推定。
- 安全な範囲でクランプ。

### 5.4 排除閾値推定
T = ターゲット灰度、E = 排除灰度。
- サンプル不足や重なりが大きい場合は保守的閾値。
- 方向判定：median(E) > median(T) なら「明るい対象を排除」。
- 明るい対象排除：
  - t90（ターゲット 90%）と e10（排除 10%）
  - t90 ≥ e10 なら重なり → e10 を採用
  - それ以外は (t90 + e10)/2
- 暗い対象排除：t10/e90 で対称処理。

### 5.5 beads 検出（2 系統融合）
**A: Yen 閾値系**
1. 中値フィルタ（Loose 以外）
2. Yen 自動閾値
3. 二値化、穴埋め
4. 開演算（Strict では 2 回）
5. Watershed
6. 面積・円形度フィルタ

**B: エッジ系（Find Edges + Otsu）**
1. Find Edges
2. Otsu 閾値
3. 二値化、穴埋め
4. 開演算（Loose 以外）
5. Watershed
6. 面積・円形度フィルタ

**融合**
- mergeDist = max(2, 0.8×r)（r は等価半径）。
- 近接候補は面積の大きい方を保持。
- Strict：二系統一致 or 大面積のみ残す。

### 5.6 厳密度による閾値スケール
- Strict：minA×0.85、maxA×1.20、circ+0.08
- Normal：minA×0.65、maxA×1.60、circ−0.06
- Loose：minA×0.50、maxA×2.10、circ−0.14

### 5.7 排除フィルタ
- 3×3 の局所平均灰度で判定。
- 面積ゲート適用可。
- HIGH：灰度 ≥ 閾値 → 除外
- LOW：灰度 ≤ 閾値 → 除外

**排除の厳密化（画像ごと）**
- mean/std を取得し、kstd = clamp(std/mean, 0.10..0.60)。
- HIGH：thr = min(userThr, mean + std*kstd)
- LOW：thr = max(userThr, mean - std*kstd)

### 5.8 塊の推定
- area > 1.35×unitArea の場合、round(area/unitArea)。
- 1..80 に制限。

### 5.9 beads → 細胞の割当
- ラベルマスクあり：ピクセル値参照。
- なし：ROI 境界判定（低速）。

### 5.10 微量貪食補正
- 非ゼロ細胞の q50 と q75 から閾値を決定。
- round((q50 + q75)/2) を最小 1 で採用。
- 閾値未満は `Cells with Beads (Adj)` に含めない。

---

## 6. データフォーマット（PN/F）

### 6.1 ファイル名規則
- 形式：`pn/f` または `f/pn`（スラッシュは 1 個）。
- `pn`：プロジェクト名、`f`/`f1`：番号。
- ソートは常に数値順。

### 6.2 列フォーマット
形式：`列1/列2/列3/...`

内蔵トークン：
- `PN`, `F`, `TB`, `BiC`, `CwB`, `CwBa`, `TC`, `IBR`, `PCR`, `eIBR`, `ePCR`

カスタム列：
- 任意のコード
- `name="..."` / `value="..."`
- `$` 付きは 1 回だけ出力
- `-F / -f` で逆順

---

## 7. データ最適化（IBR / PCR）

### 7.1 定義
- **IBR** = BiC / TB
- **PCR** = CwB / TC

### 7.2 階層的補正
- グローバル平均とプロジェクト平均を併用。
- betweenFactor / withinFactor で調整。
- 調整後の比率を計数に戻して出力。
- eIBR/ePCR は調整後のプロジェクト平均。

---

## 8. 出力

### デフォルト Results 表
- Image, Total Beads, Beads in Cells, Cells with Beads, Cells with Beads (Adj), Total Cells

### カスタム表（フォーマット有効）
- 列仕様に従って PN 展開
- `$` 列は 1 回のみ

---

## 9. 注意事項

- **ROI 数上限**：65535（16-bit 制限）。
- **ROI 欠損**：補描画/スキップ可。
- **文字化け対策**：ドラッグ＆ドロップで実行。

---

## 10. ライセンス

MIT License 推奨。コピーレフトが必要な場合は GPL‑3.0。
