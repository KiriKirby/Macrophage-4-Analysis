# 巨噬细胞图像四元素值分析
**Macrophage Image Four-Factor Analysis**

AI 编辑提示：修改前请先阅读本仓库的 `AGENTS.md`。

---

## 0. 项目概览

本仓库提供基于 **Fiji / ImageJ（ImageJ Macro Language）** 的图像分析宏，用于对显微镜图像中的**巨噬细胞与磁珠（beads）**进行半自动定量分析（当前脚本版本：**v2.2**）。

该宏覆盖完整工作流：
- 手动 **细胞 ROI 标注** 与稳健的校验
- **目标 beads 抽样** 推断尺度与默认参数
- 可选 **排除对象抽样**（多种 beads / 干扰对象）
- **双通道 beads 检测**（阈值 + 边缘）与严格度控制
- **团块按面积估算** 与细胞内统计
- 可选 **微量吞噬修正**（动态阈值）
- **数据格式化 + 数据优化**（PN/F 规则、IBR/PCR、eIBR/ePCR）

---

## 1. v2.2 更新要点

- 新增 **数据格式化模块**：支持文件名规则解析与自定义列输出。
- 新增 **数据优化（IBR/PCR）**：平衡项目间/项目内波动。
- 新增 **排除严格模式**：按图像均值/标准差动态调整阈值。
- 采样推断更稳健：面积分布鲁棒估计 + Rolling Ball 推断。

---

## 2. 环境要求

- Fiji（推荐）或 ImageJ
- 支持图像格式：`.tif / .tiff / .png / .jpg / .jpeg`

---

## 3. 运行方式（推荐）

不建议使用：

```
Fiji → Plugins → Macros → Run...
```

推荐方式：

1. 打开 Fiji
2. **将 `.ijm` 宏文件直接拖入 Fiji 主窗口**
3. Fiji 自动打开 **Macro Editor**
4. 点击 **Run** 执行

---

## 4. 工作流程（详细分阶段）

### Phase 1）语言选择
选择中文 / English / 日本語。

### Phase 2）工作模式选择
- **仅标注细胞 ROI**：只画细胞，不做 beads 分析
- **仅分析**：直接分析已有 ROI
- **标注后分析（推荐）**：完整流程

### Phase 3）文件夹选择
选择包含图像与 ROI 的文件夹。

### Phase 4）细胞 ROI 标注（如启用）
- 逐张勾画细胞轮廓，按 **T** 加入 ROI Manager。
- 默认保存为 `图像名 + _cells.zip`（可改后缀）。
- 若 ROI 已存在，可选择：编辑 / 重画覆盖 / 跳过 / 全部跳过。

### Phase 5）目标 beads 抽样
用途：推断 **典型单个 beads** 的面积尺度与背景参数。
- 用椭圆 ROI 圈选单个 beads（避免团块）。
- 在 8-bit 复制图中测量 **面积与平均灰度**。
- 可跨随机图像采样，足够后结束。

### Phase 6）排除对象抽样（可选）
用于多种 beads 或干扰对象：
- 椭圆/矩形 ROI → 学习 **灰度 + 面积**
- Freehand/Polygon ROI → 学习 **灰度**（不学习面积）

### Phase 7）参数推断
- 目标 beads 面积范围鲁棒估计
- Rolling Ball 半径估计
- 排除阈值推断（含方向）

### Phase 8）参数确认
包含：
- beads 面积范围、圆形度、团块估算、微量吞噬修正
- 严格程度（严格 / 正常 / 宽松）
- 背景 Rolling Ball 半径
- ROI 后缀
- 排除过滤（启用、方向、阈值、严格、面积门控）
- **数据格式化**（规则、列格式）与 **数据优化** 开关

### Phase 9）批量分析
每张图像：
- 打开并固定 2D / pixel 单位
- 生成 **细胞标签图**（16-bit）
- 生成 8-bit beads 图并背景扣除
- 双通道 beads 检测并融合
- 可选排除过滤
- 统计 beads 与细胞内分布

### Phase 10）结果输出
- 关闭数据格式化：输出标准 Results 表
- 开启数据格式化：按 PN/F 与列格式生成自定义表

---

## 5. 核心算法（专业细节）

### 5.1 ROI → 16-bit 标签图
- 以 ROI 编号填充为 16-bit 标签图（1..65535）。
- 用像素值快速判断 beads 属于哪个细胞。
- ROI 超过 65535 或 ROI[1] 无效时终止，防止错误统计。

### 5.2 目标 beads 抽样 → 鲁棒面积推断
- 以排序/分位数/IQR 进行鲁棒估计。
- 得到 `[minA, maxA]` 与代表面积（unit area）。
- 样本不足则回退默认值。

### 5.3 Rolling Ball 估计
- 由代表面积换算等效直径后估计背景半径。
- 进行上下限 clamp，防止极端。

### 5.4 排除阈值推断
令 **T** = 目标 beads 灰度均值，**E** = 排除对象灰度均值。
- 样本 < 3 或重叠严重时采用保守阈值。
- 方向判断：若 `median(E) > median(T)` → 排除亮对象；否则排除暗对象。
- 排除亮对象：
  - t90（目标 90% 分位）与 e10（排除 10% 分位）
  - 若 t90 ≥ e10（重叠） → 取 e10 作为保守阈值
  - 否则阈值 = (t90 + e10) / 2
- 排除暗对象：用 t10 与 e90 对称处理。

### 5.5 beads 检测：双通道融合
**通道 A（Yen 阈值）**
1. 可选中值滤波（非宽松）
2. Yen 自动阈值
3. 转二值、填孔
4. 开运算（严格模式会多开一次）
5. Watershed 分割
6. 按面积 + 圆形度筛选

**通道 B（Find Edges + Otsu）**
1. Find Edges
2. Otsu 阈值
3. 转二值、填孔
4. 开运算（非宽松）
5. Watershed 分割
6. 按面积 + 圆形度筛选

**融合策略**
- 以 `mergeDist = max(2, 0.8 * r)` 合并近邻候选（r 为等效半径）。
- 距离内保留**面积更大**的候选。
- 严格模式仅保留双通道一致或大面积候选（≥ 1.25×代表面积）。

### 5.6 严格程度对阈值的缩放
- **严格**：minA×0.85，maxA×1.20，circ+0.08
- **正常**：minA×0.65，maxA×1.60，circ−0.06
- **宽松**：minA×0.50，maxA×2.10，circ−0.14

### 5.7 排除过滤（逐候选）
- 计算候选中心 3×3 局部均值灰度。
- 可选面积门控：只在 `[exclMinA, exclMaxA]` 内应用。
- HIGH：灰度 ≥ 阈值则排除；LOW：灰度 ≤ 阈值则排除。

**严格排除（逐图像自适应）**
- 计算图像均值/标准差；`kstd = clamp(std/mean, 0.10..0.60)`。
- HIGH：`thr = min(userThr, mean + std*kstd)`
- LOW：`thr = max(userThr, mean - std*kstd)`

### 5.8 团块 beads 估算
- 若 `area > 1.35 × unitArea`：
  - `count = round(area / unitArea)`，并限制在 1..80。

### 5.9 beads → 细胞归属
- 有标签图：直接像素查询。
- 无标签图：ROI 边界判定（较慢）。

### 5.10 微量吞噬修正（可选）
- 统计每个细胞的 beads 数（>0）。
- 计算 q50 与 q75。
- 动态阈值 = round((q50 + q75)/2)，最小为 1。
- 低于阈值的细胞不计入 `Cells with Beads (Adj)`。

---

## 6. 数据格式化（PN/F）与输出规则

### 6.1 文件名规则
- 规则格式：`pn/f` 或 `f/pn`（必须且仅一个 “/”）。
- 代号：
  - `pn`：项目名（非数字部分）
  - `f`：编号（1,2,3…）
  - `f1`：编号（01/001…）
- 排序永远按 **数字大小**。

### 6.2 列格式
格式：`列1/列2/列3/...`

内置列代号：
- `PN`, `F`, `TB`, `BiC`, `CwB`, `CwBa`, `TC`, `IBR`, `PCR`, `eIBR`, `ePCR`

自定义列：
- 任意非内置代号
- 参数：
  - `name="..."` 列名
  - `value="..."` 常量值
- `$` 前缀：自定义列仅显示一次（不随项目扩展）
- `-F / -f`：按 F 倒序排序

---

## 7. 数据优化（IBR / PCR）

### 7.1 定义
- **IBR** = BiC / TB
- **PCR** = CwB / TC

### 7.2 优化逻辑（分层平滑）
宏计算：
- 全局均值 gIBR / gPCR
- 每个项目 PN 的均值
- 每张图像的原始比值

并通过以下因子进行调整：
- **betweenFactor**：项目数越多，项目均值权重越高
- **withinFactor**：项目内样本数越多，单图像偏差权重越低

最终将调整后的比值转换回 **调整后的计数**，用于：
- BiC / CwB 输出
- eIBR / ePCR（项目均值）计算

该方法在不破坏趋势的前提下，降低样本量不均带来的波动。

---

## 8. 输出结果

### 关闭数据格式化
Results 表字段：
- Image, Total Beads, Beads in Cells, Cells with Beads, Cells with Beads (Adj), Total Cells

### 开启数据格式化
- 结果列由列格式控制
- 多项目会展开成 PN 后缀列
- `$` 列仅显示一次

---

## 9. 注意事项

- **ROI 数量上限**：65535（16-bit 标签图限制）。
- **缺失 ROI**：可现场补标注或跳过（结果保留空行）。
- **编码问题**：建议拖拽运行，避免中文/日文乱码。

---

## 10. 许可证

推荐 MIT License；如需强制开源可选 GPL‑3.0。
